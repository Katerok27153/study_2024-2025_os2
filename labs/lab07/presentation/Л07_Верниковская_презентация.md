---
## Front matter
lang: ru-RU
title: Лабораторная работа №7
subtitle: Основы администрирования операционных систем
author:
  - Верниковская Е. А., НПИбд-01-23
institute:
  - Российский университет дружбы народов, Москва, Россия
date: 17 октября 2024

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
 - '\makeatletter'
 - '\beamer@ignorenonframefalse'
 - '\makeatother'
 
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
---

# Вводная часть

## Цель работы

Получить навыки работы с журналами мониторинга различных событий в системе.

## Задание

1. Продемонстрировать навыки работы с журналом мониторинга событий в реальном времени 
2. Продемонстрировать навыки создания и настройки отдельного файла конфигурации мониторинга отслеживания событий веб-службы 
3. Продемонстрировать навыки работы с journalctl
4. Продемонстрировать навыки работы с journald 

# Выполнение лабораторной работы

## Мониторинг журнала системных событий в реальном времени

Запускаем три вкладки терминала и в каждой из них получаем полномочия суперпользователя, используя *su -* (рис. 1)

![Режим суперпользователя](image/лаба7_1.png){#fig:001 width=70%}

## Мониторинг журнала системных событий в реальном времени

На второй вкладке терминала запустите мониторинг системных событий в реальном времени, с помощью *tail -f /var/log/messages* (рис. 2)

![Мониторинг системных событий в реальном времени](image/лаба7_2.png){#fig:002 width=70%}

## Мониторинг журнала системных событий в реальном времени

В третьей вкладке терминала возвращаемся к учётной записи своего пользователя (для этого нажимаем ctrl+d) и пробуем получить полномочия администратора, но на этот раз вводим неправильный пароль (рис. 3)

![Попытка получить права суперпользователя](image/лаба7_3.png){#fig:003 width=70%}

## Мониторинг журнала системных событий в реальном времени

Во второй вкладке терминала с мониторингом событий после неудачной попытки получить права администратора появится сообщение «FAILED SU (to root) username ...» (рис. 4)

![Сообщение о неудачной попытки получить права root](image/лаба7_4.png){#fig:004 width=70%}

## Мониторинг журнала системных событий в реальном времениs

В третьей вкладке терминала из оболочки пользователя вводим *logger hello* (рис. 5])

![Послание тестового сообщения "hello"](image/лаба7_5.png){#fig:005 width=70%}

## Мониторинг журнала системных событий в реальном времени

Во второй вкладке терминала с мониторингом событий мы увидим сообщение, которое до этого написали с помощью *logger* (рис. 6)

![Тестовое сообщение "hello"](image/лаба7_6.png){#fig:006 width=70%}

## Мониторинг журнала системных событий в реальном времени

Во второй вкладке терминала с мониторингом останавливаем трассировку файла сообщений мониторинга реального времени, используя ctrl+c, а затем запускаем мониторинг сообщений безопасности (последние 20 строк соответствующего файла логов), с помощью *tail -n 20 /var/log/secure*. Там мы увидим сообщения, которые ранее были зафиксированы во время ошибки авторизации при вводе команды su (рис. 7)

## Мониторинг журнала системных событий в реальном времени

![Мониторинг сообщений безопасности](image/лаба7_7.png){#fig:007 width=70%}

## Изменение правил rsyslog.conf

По умолчанию веб-служба не регистрирует свои сообщения через rsyslog, а пишет свой собственный журнал (в каталоге /var/log/httpd). Настроим регистрацию сообщений веб-службы через syslog, создав правило, регистрирующее отладочные сообщения в отдельном лог-файле.

## Изменение правил rsyslog.conf

В первой вкладке терминала установим Apache командой *dnf -y install httpd* (рис. 8)

![Установка Apache](image/лаба7_8.png){#fig:008 width=70%} 

## Изменение правил rsyslog.conf

После окончания процесса установки запускаем веб-служб командами *systemctl start httpd* и *systemctl enable httpd* (рис. 9)

![Запуск службы httpd](image/лаба7_9.png){#fig:009 width=70%} 

## Изменение правил rsyslog.conf

Во второй вкладке терминала посмотрим журнал сообщений об ошибках веб-службы, с помощью *tail -f /var/log/httpd/error_log*. Для закрытия используем ctrl+c (рис. 10)

![Журнал сообщений об ошибках веб-службы httpd](image/лаба7_10.png){#fig:010 width=70%}

## Изменение правил rsyslog.conf

В третьей вкладке терминала получаем полномочия администратора и в файле конфигурации /etc/httpd/conf/httpd.conf в конце добавляем строку *ErrorLog syslog:local1*. Добавление этой строки в конец файла конфигурации изменит способ регистрации ошибок веб-сервера. Ошибки будут отправляться на систему журналирования через syslog в локальную категорию local1 (рис. 11), (рис. 12)

![Получение прав пользователя root и открытие файла /etc/httpd/conf/httpd.conf](image/лаба7_11.png){#fig:011 width=70%}

## Изменение правил rsyslog.conf

![Редактирование файла /etc/httpd/conf/httpd.conf](image/лаба7_12.png){#fig:012 width=40%}

## Изменение правил rsyslog.conf

Далее в каталоге /etc/rsyslog.d создаём файл мониторинга событий веб-службы (рис. 13)

![Создание файла мониторинга событий веб-службы](image/лаба7_13.png){#fig:013 width=70%}

## Изменение правил rsyslog.conf

Открыв его на редактирование, прописываем в нём строку local1.* -/var/log/httpd-error.log. Эта строка позволит отправлять все сообщения, получаемые для объекта local1 (который теперь используется службой httpd), в файл /var/log/httpd-error.log (рис. 14), (рис. 15)

![Открытие файла /etc/rsyslog.d/httpd.conf](image/лаба7_14.png){#fig:014 width=70%}

## Изменение правил rsyslog.conf

![Редактирование файла /etc/rsyslog.d/httpd.conf](image/лаба7_15.png){#fig:015 width=70%}

## Изменение правил rsyslog.conf

Переходим в первую вкладку терминала и перезагружаем конфигурацию rsyslogd и веб-службу команжой *systemctl restart*. Все сообщения об ошибках веб-службы теперь будут записаны в файл
/var/log/httpd-error.log, что можно наблюдать или в режиме реального времени, используя команду tail с соответствующими параметрами, или непосредственно просматривая указанный файл (рис. 16)

![Перезагрузка конфигурации rsyslogd и веб-службы](image/лаба7_16.png){#fig:016 width=70%}

## Изменение правил rsyslog.conf

В третьей вкладке терминала создаём отдельный файл конфигурации для мониторинга отладочной информации (рис. 17)

![Создание отдельного файла конфигурации для мониторинга отладочной информации](image/лаба7_17.png){#fig:017 width=70%}

## Изменение правил rsyslog.conf

В этом же терминале пишем команду echo "*.debug /var/log/messages-debug" > /etc/rsyslog.d/debug.conf (рис. 18)

![Ввод нужной команды](image/лаба7_18.png){#fig:018 width=70%}

## Изменение правил rsyslog.conf

В первой вкладке терминала снова перезапускаем rsyslogd (рис. 19)

![Перезапуск rsyslogd](image/лаба7_19.png){#fig:019 width=70%}

## Изменение правил rsyslog.conf

Во второй вкладке терминала запускаем мониторинг отладочной информации с помощью *tail -f /var/log/messages-debug* (рис. 20)

![Мониторинг отладочной информации](image/лаба7_20.png){#fig:020 width=70%}

## Изменение правил rsyslog.conf

В третьей вкладке терминала вводим *logger -p daemon.debug "Daemon Debug Message"* (рис. 21)

![Создание тестового сообщения уровня debug](image/лаба7_21.png){#fig:021 width=70%}

## Изменение правил rsyslog.conf
 
После этого мы увидим в терминале с мониторингом отладочной информации наше сообщение, которое мы создали с помощью *logger* (рис. 22)

![Тестовое сообщение уровня debug](image/лаба7_22.png){#fig:022 width=70%}

## Использование journalctl

Во второй вкладке терминала посмотрим содержимое журнала с событиями с момента последнего запуска системы  с помощью *journalctl* (рис. 23)

![Просмотр содержимого журнала событий с момента последнего запуска системы](image/лаба7_23.png){#fig:023 width=70%}

## Использование journalctl

Далее посмотрим содержимоге журнала без использования пейджера с помощью *journalctl --no-pager*. Это означает, что вывод соообщений будет отображатся сразу весь, без возможности прокручивания содержимого (рис. 24)

![Просмотр содержимого журнала событий без использования пейджера](image/лаба7_24.png){#fig:024 width=70%}

## Использование journalctl

Далее посмотрим журнал в реальном времени командой *journalctl -f*. Для прерывания просмотра используем также ctrl+c (рис. 25)

![Просмотр журнала в реальном времени](image/лаба7_25.png){#fig:025 width=70%}

## Использование journalctl

Для использования фильтрации просмотра конкретных параметров журнала вводим *journalctl* и дважды нажимаем на клавишу *Tab* (рис. 26)

![Просмотр конкретных параметров. Надеюсь это то))))](image/лаба7_26.png){#fig:026 width=70%}

## Использование journalctl

Смотрим события UID0 командой *journalctl _UID=0* (рис. 27)

![События UID0](image/лаба7_27.png){#fig:027 width=70%}

## Использование journalctl

Для отображения последних 20 строк журнала вводим команду *journalctl -n 20* (рис. 28)

![Просмотр последних 20 строк журнала](image/лаба7_28.png){#fig:028 width=70%}

## Использование journalctl

Для просмотра только сообщений об ошибках вводим *journalctl -p err* (рис. 29)

![Просмотр сообщений только об ошибках](image/лаба7_29.png){#fig:029 width=70%}

## Использование journalctl

Если мы хотим просмотреть сообщения журнала, записанные за определённый период времени, мы можем использовать параметры --since и --until. Обе опции принимают параметр времени в формате YYYY-MM-DD hh:mm:ss. Кроме того, мы можем использовать yesterday, today и tomorrow в качестве параметров.

## Использование journalctl

Для просмотра всех сообщений со вчерашнего дня вводим *journalctl --since yesterday* (рис. 30)

![Просмотр всех сообщений со вчерашнего дня](image/лаба7_30.png){#fig:030 width=70%}

## Использование journalctl

Далее просматриваем все сообщения с ошибкой приоритета, которые были зафиксированы со вчерашнего дня. Для этого используем команду *journalctl --since yesterday -p err* (рис. 31)

![Просмотр всех сообщений с ошибкой приоритета со вчерашнего дня](image/лаба7_31.png){#fig:031 width=70%}

## Использование journalctl

Посмотрим детальную информацию с помощью *journalctl -o verbose* (рис. 32)

![Просмотр детальной информации](image/лаба7_32.png){#fig:032 width=70%}

## Использование journalctl

Для просмотра дополнительной информации о модуле sshd вводим *journalctl _SYSTEMD_UNIT=sshd.service* (рис. 33)

![Просмотр дополнительной информации о модуле sshd](image/лаба7_33.png){#fig:033 width=70%}

## Постоянный журнал journald

Запускаем терминал и получаем полномочия администратора (рис. 34)

![Режим root](image/лаба7_34.png){#fig:034 width=70%}

## Постоянный журнал journald

Создаём каталог для хранения записей журнала *mkdir -p /var/log/journal* (рис. 35)

![Создание каталога для хранения записей журнала](image/лаба7_35.png){#fig:035 width=70%}

## Постоянный журнал journald

Скорректируем права доступа для каталога /var/log/journal, чтобы journald смог записывать в него информацию. Для этого введём команды *chown root:systemd-journal /var/log/journal* и *chmod 2755 /var/log/journal* (рис. 36)

![Установление прав доступа для каталога /var/log/journal](image/лаба7_36.png){#fig:036 width=70%}

## Постоянный журнал journald

Для принятия изменений необходимо или перезагрузить систему (перезапустить
службу systemd-journald недостаточно), или использовать команду *killall -USR1 systemd-journald*, что мы и делаем (рис. 37)

![Команда killall -USR1 systemd-journald](image/лаба7_37.png){#fig:037 width=70%}

## Постоянный журнал journald

Журнал systemd теперь постоянный. Теперь посмотрим сообщения журнала с момента последней перезагрузки с помошью команды *journalctl -b*  (рис. 38)

![Сообщения журнала с момента последней перезагрузки](image/лаба7_38.png){#fig:038 width=70%}

# Подведение итогов

## Выводы

В ходе выполнения лабораторной работы мы получили навыки работы с журналами мониторинга различных событий в системе.

## Список литературы

1. Лаборатораня работа №7 [Электронный ресурс] URL: https://esystem.rudn.ru/pluginfile.php/2400710/mod_resource/content/4/008-syslog.pdf
