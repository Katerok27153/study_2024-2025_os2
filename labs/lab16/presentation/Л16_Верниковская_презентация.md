---
## Front matter
lang: ru-RU
title: Лабораторная работа №16
subtitle: Основы администрирования операционных систем
author:
  - Верниковская Е. А., НПИбд-01-23
institute:
  - Российский университет дружбы народов, Москва, Россия
date: 21 декабря 2024

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
 - '\makeatletter'
 - '\beamer@ignorenonframefalse'
 - '\makeatother'
 
## Fonts
mainfont: PT Serif
romanfont: PT Serif
sansfont: PT Sans
monofont: PT Mono
mainfontoptions: Ligatures=TeX
romanfontoptions: Ligatures=TeX
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase
monofontoptions: Scale=MatchLowercase,Scale=0.9
---

# Вводная часть

## Цель работы

Освоить работу с RAID-массивами при помощи утилиты mdadm.

## Задание

1. Добавить три диска на виртуальную машину (объёмом от 512 MiB каждый). При помощи sfdisk создать на каждом из дисков по одной партиции, задав тип раздела для RAID 
2. Создать массив RAID 1 из двух дисков, смонтировать его. Эмитировать сбой одного из дисков массива, удалить искусственно выведенный из строя диск, добавить в массив работающий диск
3. Создать массив RAID 1 из двух дисков, смонтировать его. Добавить к массиву третий диск. Эмитировать сбой одного из дисков массива. Проанализировать состояние массива, указать различия по сравнению с предыдущим случаем
4. Создать массив RAID 1 из двух дисков, смонтировать его. Добавить к массиву третий диск. Изменить тип массива с RAID1 на RAID5, изменить число дисков в массиве с 2 на 3. Проанализировать состояние массива, указать различия по сравнению с предыдущим случаем

# Выполнение лабораторной работы

## Создание виртуальных носителей

Добавляем к нашей виртуальной машине к контроллеру SATA три диска размером 512 MiB (рис. 1)

![Добавление к контроллеру SATA трёх дисков](image/лаба16_1.png){#fig:001 width=60%}

## Создание виртуальных носителей

Запускаем терминала и получаем полномочия суперпользователя, используя *su -* (рис. 2)

![Режим суперпользователя](image/лаба16_2.png){#fig:002 width=70%}

## Создание виртуальных носителей

Проверим наличие созданных нами на предыдущем этапе дисков: *fdisk -l | grep /dev/sd*. В системе добавленные диски отображаются как /dev/sdd, /dev/sde, /dev/sdf (рис. 3)

![Проверка наличия созданных дисков](image/лаба16_3.png){#fig:003 width=60%}

## Создание виртуальных носителей

Создадим на каждом из дисков раздел: *sfdisk /dev/sdd <<EOF*, *sfdisk /dev/sde <<EOF* и *sfdisk /dev/sdf <<EOF* (рис. 4), (рис. 5), (рис. 6)

![Создание раздела на диске /dev/sdd](image/лаба16_4.png){#fig:004 width=50%}

## Создание виртуальных носителей

![Создание раздела на диске /dev/sde](image/лаба16_5.png){#fig:005 width=50%}

## Создание виртуальных носителей

![Создание раздела на диске /dev/sdf](image/лаба16_6.png){#fig:006 width=50%}

## Создание виртуальных носителей

Проверим текущий тип созданных разделов: *sfdisk --print-id /dev/sdd 1*, *sfdisk --print-id /dev/sde 1* и *sfdisk --print-id /dev/sdf 1*. Созданные нами разделы на дисках имеют тип 83 (Linux) (рис. 7)

![Проверка текущего типа созданных разделов](image/лаба16_7.png){#fig:007 width=70%}

## Создание виртуальных носителей

Посмотрим, какие типы партиций, относящиеся к RAID, можно задать: *sfdisk -T | grep -i raid* (рис. 8)

![Типы партиций, относящиеся к RAID](image/лаба16_8.png){#fig:008 width=70%} 

## Создание виртуальных носителей

Установим тип разделов в Linux raid autodetect: *sfdisk --change-id /dev/sdd 1 fd*, *sfdisk --change-id /dev/sde 1 fd* и  *sfdisk --change-id /dev/sdf 1 fd* (рис. 9)

![Установление типа разделов в Linux raid autodetect](image/лаба16_9.png){#fig:009 width=50%} 

## Создание виртуальных носителей

Посмотрим состояние дисков: *sfdisk -l /dev/sdd*, *sfdisk -l /dev/sde* и  *sfdisk -l /dev/sdf*. Тип разделов изменился на Linux raid autodetect (рис. 10)

![Состояния дисков](image/лаба16_10.png){#fig:010 width=30%} 

## Создание виртуальных носителей

При помощи утилиты *mdadm* создадим массив RAID 1 из двух дисков: *mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdd1 /dev/sde1* (рис. 11)

![Создание массива RAID 1 из двух дисков (1)](image/лаба16_11.png){#fig:011 width=70%}

## Создание виртуальных носителей

Проверим состояние массива RAID, используя команды *cat /proc/mdstat*, *mdadm --query /dev/md0* и  *mdadm --detail /dev/md0* (рис. 12)

![Состояние массива RAID (1)](image/лаба16_12.png){#fig:012 width=50%}

## Создание виртуальных носителей

Создадим файловую систему на RAID: *mkfs.ext4 /dev/md0* (рис. 13)

![Создание файловой системы ext4 на RAID](image/лаба16_13.png){#fig:013 width=70%} 

## Создание виртуальных носителей

Подмонтируем RAID: *mkdir /data* и *mount /dev/md0 /data* (рис. 14)

![Подмонтирование RAID](image/лаба16_14.png){#fig:014 width=70%} 

## Создание виртуальных носителей

Далее для автомонтирования добавим запись в /etc/fstab: */dev/md0 /data ext4 defaults 1 2* (рис. 15), (рис. 16)

![Открытие файла /etc/fstab (1)](image/лаба16_15.png){#fig:015 width=70%} 

## Создание виртуальных носителей

![Редактирование файла /etc/fstab (1)](image/лаба16_16.png){#fig:016 width=70%} 

## Создание виртуальных носителей

Сымитируем сбой одного из дисков: *mdadm /dev/md0 --fail /dev/sde1* (рис. 17)

![Имитирование сбоя диска /dev/sde1 (1)](image/лаба16_17.png){#fig:017 width=70%} 

## Создание виртуальных носителей

Удалим сбойный диск: *mdadm /dev/md0 --remove /dev/sde1* (рис. 18)

![Удаление сбойного диска /dev/sde1](image/лаба16_18.png){#fig:018 width=70%}

## Создание виртуальных носителей

Заменим диск в массиве: *mdadm /dev/md0 --add /dev/sdf1* (рис. 19)

![Замена сбойного диска на /dev/sdf1](image/лаба16_19.png){#fig:019 width=70%}

## Создание виртуальных носителей

Посмотрим состояние массива (рис. 20)

![Состояние массива RAID (2)](image/лаба16_20.png){#fig:020 width=50%}

## Создание виртуальных носителей

Удалим массив и очистим метаданные: *umount /dev/md0*, *mdadm --stop /dev/md0*, *mdadm --zero-superblock /dev/sdd1*, *mdadm --zero-superblock /dev/sde1* и *mdadm --zero-superblock /dev/sdf1* (рис. 21)

![Удаление массива и очистка метаданных (1)](image/лаба16_21.png){#fig:021 width=70%} 

## RAID-массив с горячим резервом (hotspare)

Создадим массив RAID 1 из двух дисков: *mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdd1 /dev/sde1* (рис. 22)

![Создание массива RAID 1 из двух дисков (2)](image/лаба16_22.png){#fig:022 width=70%} 

## RAID-массив с горячим резервом (hotspare)

Добавим третий диск: *mdadm --add /dev/md0 /dev/sdf1* (рис. 23)

![Добавление третьего диска /dev/sdf1 (1)](image/лаба16_23.png){#fig:023 width=70%} 

## RAID-массив с горячим резервом (hotspare)

Подмонтируем /dev/md0 *mount /dev/md0* (рис. 24)

![Подмонтирование /dev/md0 (1)](image/лаба16_24.png){#fig:024 width=70%} 

## RAID-массив с горячим резервом (hotspare)

Проверим состояние массива (рис. 25)

![Состояние массива RAID (3)](image/лаба16_25.png){#fig:025 width=50%} 

## RAID-массив с горячим резервом (hotspare)

Сымитируем сбой одного из дисков: *mdadm /dev/md0 --fail /dev/sde1* (рис. 26)

![Имитирование сбоя диска /dev/sde1 (2)](image/лаба16_26.png){#fig:026 width=70%} 

## RAID-массив с горячим резервом (hotspare)

Проверим состояние массива: *mdadm --detail /dev/md0* (рис. 27)

![Состояние массива RAID (4)](image/лаба16_27.png){#fig:027 width=50%}

## RAID-массив с горячим резервом (hotspare)

Удалим массив и очистим метаданные (рис. 28)

![Удаление массива и очистка метаданных (2)](image/лаба16_28.png){#fig:028 width=70%} 

## Преобразование массива RAID 1 в RAID 5

Создайте массив RAID 1 из двух дисков: *mdadm --create --verbose /dev/md0 --level=1 --raid-devices=2 /dev/sdd1 /dev/sde1* (рис. 29)

![Создание массива RAID 1 из двух дисков (3)](image/лаба16_29.png){#fig:029 width=70%}

## Преобразование массива RAID 1 в RAID 5 

Добавим третий диск: *mdadm --add /dev/md0 /dev/sdf1* (рис. 30)

![Добавление третьего диска /dev/sdf1 (2)](image/лаба16_30.png){#fig:030 width=70%} 

## Преобразование массива RAID 1 в RAID 5

Подмонтируем /dev/md0 (рис. 31)

![Подмонтирование /dev/md0 (2)](image/лаба16_31.png){#fig:031 width=70%} 

## Преобразование массива RAID 1 в RAID 5

Проверим  состояние массива (рис. 32)

![Состояние массива RAID (5)](image/лаба16_32.png){#fig:032 width=50%}

## Преобразование массива RAID 1 в RAID 5

Измените тип массива RAID: *mdadm --grow /dev/md0 --level=5* (рис. 33)

![Изменение типа массива RAID](image/лаба16_33.png){#fig:033 width=70%}

## Преобразование массива RAID 1 в RAID 5

Проверим состояние массива (рис. 34)

![Состояние массива RAID (6)](image/лаба16_34.png){#fig:034 width=50%}

## Преобразование массива RAID 1 в RAID 5

Изменим количество дисков в массиве RAID 5: *mdadm --grow /dev/md0 --raid-devices 3* (рис. 35)

![Изменение количества дисков в массиве RAID 5](image/лаба16_35.png){#fig:035 width=70%}

## Преобразование массива RAID 1 в RAID 5

Проверим состояние массива (рис. 36)

![Состояние массива RAID (7)](image/лаба16_36.png){#fig:036 width=50%}

## Преобразование массива RAID 1 в RAID 5

Удалим массив и очистим метаданные (рис. 37)

![Удаление массива и очистка метаданных (3)](image/лаба16_37.png){#fig:037 width=70%} 

## Преобразование массива RAID 1 в RAID 5

Закомментируем запись в /etc/fstab: */dev/md0 /data ext4 defaults 1 2* (рис. 38), (рис. 39)

![Открытие файла /etc/fstab (2)](image/лаба16_38.png){#fig:038 width=70%} 

## Преобразование массива RAID 1 в RAID 5

![Редактирование файла /etc/fstab (2)](image/лаба16_39.png){#fig:039 width=70%}  

# Подведение итогов

## Выводы

В ходе выполнения лабораторной работы мы освоили работу с RAID-массивами при помощи утилиты mdadm

sdsdkjsds

## Список литературы

1. Лаборатораня работа №16 [Электронный ресурс] URL: https://esystem.rudn.ru/pluginfile.php/2400765/mod_resource/content/4/017-mdadm_raid.pdf
